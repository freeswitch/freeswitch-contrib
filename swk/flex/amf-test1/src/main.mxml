<?xml version="1.0" encoding="utf-8"?>
<mx:Application xmlns:mx="http://www.adobe.com/2006/mxml" layout="absolute">

	 <mx:Script>
        <![CDATA[
        
        	import flash.utils.Timer;
            import flash.events.TimerEvent;
                    
			import mx.controls.dataGridClasses.DataGridColumn;
			import mx.events.DataGridEvent;
			import mx.controls.Alert;
			import mx.rpc.events.FaultEvent;
			import mx.rpc.events.ResultEvent;
			import mx.collections.ArrayCollection;
			import mx.managers.PopUpManager;
			import mx.core.IFlexDisplayObject;
			private var confTimer:Timer;
            
            private function initConfTab():void{
            	freeswitch.getConfPlayfiles(null);
            	freeswitch.getConferenceList();
            	freeswitch.getConferenceUsers(confPicker.selectedItem );
				confTimerLabel.text="Init...";
				confTimer = new Timer(10000, 0);
				confTimer.addEventListener(TimerEvent.TIMER, onConfRefresh);
				confTimer.start();
				confTimerLabel.text = confTimer.running.toString();
			}
            
            private function onConfRefresh(evt:TimerEvent):void {
            	confTimerLabel.text="Refreshing";
            	freeswitch.getConferenceUsers(confPicker.selectedItem);
            	confTimerLabel.text="Refreshed";
            	confTimerSecCount.text = confTimer.currentCount.toString();
            }
            
            private function confAutoRefreshControl():void {
            	if (confAutoRefreshCheckBox.selected) {
            		confTimer.start();
            		confTimerLabel.text="running";
            		confTimerLabel.text = confTimer.running.toString();
            		confTimerSecCount.text = confTimer.currentCount.toString();
            	} else {
            		confTimer.stop();
            		confTimerLabel.text="stopped";
            		confTimerLabel.text = confTimer.running.toString();
            		confTimerSecCount.text = confTimer.currentCount.toString();
            	}
            }
            
            private function confTimerChangeTime():void {
            	confTimer.delay = confAutoRefreshTimeSlider.value * 1000;
            }
            
            public function doOriginate():void {
				var origWindow:IFlexDisplayObject =
					PopUpManager.createPopUp(this, originateForm, false);
			}
            public function doStatusForm():void {
				var origWindow:IFlexDisplayObject =
					PopUpManager.createPopUp(this, statusForm, false);
			}
           
        ]]>
    </mx:Script>

    <!-- this is the RemoteObject  used to make the RPC calls -->
    <mx:RemoteObject id="freeswitch" destination="freeswitch" source="freeswitch"
            endpoint="/feeder/gateway.php" showBusyCursor="true"/>

    <mx:TabNavigator width="100%" height="100%">
        <mx:Canvas label="Channels" width="100%" height="100%" show="freeswitch.getChannels();">
        	
		        <mx:Button label="Refresh" click="freeswitch.getChannels();" />
		        <mx:DataGrid id="channelsGrid" dataProvider="{freeswitch.getChannels.lastResult}" left="0" top="30" bottom="0" right="0">
		            <mx:columns>
		                <mx:DataGridColumn dataField="uuid" editable="false"/>
		                <mx:DataGridColumn dataField="cid_name"/>
		                <mx:DataGridColumn dataField="cid_num"/>
		                <mx:DataGridColumn dataField="dest"/>
		                <mx:DataGridColumn dataField="created"/>
		                <mx:DataGridColumn dataField="read_codec"/>
		                <mx:DataGridColumn dataField="write_codec"/>
		            </mx:columns>
		        </mx:DataGrid>
	        
        	<mx:Button label="Originate" click="doOriginate();"  x="81"/>
        	<mx:Button label="Kill UUID" click="freeswitch.killUuid(callsGrid.selectedItem.caller_uuid); freeswitch.getCalls();"  x="168"/>
        	<mx:Button label="Status" click="doStatusForm()"  x="253"/>
        </mx:Canvas>
        <mx:Canvas label="Calls" width="100%" height="100%" show="freeswitch.getCalls();">

		        <mx:Button label="Refresh" click="freeswitch.getCalls();" />
		        <mx:Button label="Originate" click="doOriginate();"  x="79"/>
		        <mx:Button label="Kill UUID" click="freeswitch.killUuid(callsGrid.selectedItem.caller_uuid); freeswitch.getCalls();"  x="166"/>
		        <mx:Button label="Status" click="doStatusForm()"  x="251"/>
		        <!-- <mx:DataGrid id="myGrid" dataProvider="{myRemote.getCalls.lastResult}" editable="true" itemEditEnd="save(event)"> -->
		        <mx:DataGrid id="callsGrid" dataProvider="{freeswitch.getCalls.lastResult}" top="30" bottom="0" left="0" right="0">
		            <mx:columns>
		                <mx:DataGridColumn dataField="created"/>
		                <mx:DataGridColumn dataField="caller_uuid"/>
		                <mx:DataGridColumn dataField="callee_uuid"/>
		                <mx:DataGridColumn dataField="caller_cid_name"/>
		                <mx:DataGridColumn dataField="caller_cid_num"/>
		                <mx:DataGridColumn dataField="caller_dest_num"/>
		            </mx:columns>
		        </mx:DataGrid>

        </mx:Canvas>
        <mx:Canvas label="Conference" width="100%" height="100%" show="initConfTab();">
        	<mx:ComboBox id="confPicker" horizontalCenter="0" top="10" dataProvider="{freeswitch.getConferenceList.lastResult}" 
        		change="{freeswitch.getConferenceUsers(confPicker.selectedItem)}"></mx:ComboBox>
	        <mx:DataGrid id="conferenceGrid" dataProvider="{freeswitch.getConferenceUsers.lastResult}" width="100%" top="43" bottom="145">
	            <mx:columns>
	                <mx:DataGridColumn dataField="id"/>
	                <mx:DataGridColumn dataField="caller_name"/>
	                <mx:DataGridColumn dataField="caller_number" />
	                <mx:DataGridColumn dataField="channel" />
	                <mx:DataGridColumn dataField="uuid"/>
	                <mx:DataGridColumn dataField="volume"/>
	                <mx:DataGridColumn dataField="gain"/>
	                <mx:DataGridColumn dataField="noise"/>
	                <mx:DataGridColumn dataField="flags"/>
	            </mx:columns>
	        </mx:DataGrid>
	        <mx:Button label="Play File" click="freeswitch.confPlayfile(confPicker.selectedItem, comboConfPlayfile.selectedItem.data);;" horizontalCenter="-40" bottom="85"/>
	        <mx:Button label="Speak" click="{freeswitch.getConferenceUsers(confPicker.selectedItem)}" horizontalCenter="221" bottom="25"/>
	        <mx:Button label="Refersh Confs" click="{freeswitch.getConferenceList()}" horizontalCenter="-276" bottom="115"/>
	        <mx:Button label="Refresh Conf Users" click="{freeswitch.getConferenceUsers(confPicker.selectedItem)}" horizontalCenter="-262" bottom="85"/>
	        <mx:Button label="Kick" click="{freeswitch.kickConferenceUser(confPicker.selectedItem, conferenceGrid.selectedItem.id)}" horizontalCenter="-155" bottom="85"/>
	        <mx:Button label="DTMF" click="{freeswitch.getCalls()}" horizontalCenter="98" bottom="25"/>
	        <mx:Button label="Transfer" click="{freeswitch.getCalls()}" horizontalCenter="24" bottom="25"/>
	        <mx:Button label="Mute" click="{freeswitch.confMute(confPicker.selectedItem, conferenceGrid.selectedItem.id)}" horizontalCenter="-303" bottom="55"/>
	        <mx:Button label="Unmute" click="{freeswitch.confUnmute(confPicker.selectedItem, conferenceGrid.selectedItem.id)}" horizontalCenter="-230" bottom="55"/>
	        <mx:Button label="Volume" click="{freeswitch.getCalls()}" horizontalCenter="-295" bottom="25"/>
	        <mx:Button label="Gain" click="{freeswitch.getCalls()}" horizontalCenter="-227" bottom="25"/>
	        <mx:Button label="Dial" click="{freeswitch.getCalls()}" horizontalCenter="158" bottom="25"/>
	        <mx:Button label="Lock" click="freeswitch.confLock(confPicker.selectedItem);" horizontalCenter="-156" bottom="55"/>
	        <mx:Button label="Unlock" click="freeswitch.confUnlock(confPicker.selectedItem);" horizontalCenter="-162" bottom="25"/>
	        <mx:CheckBox id="confAutoRefreshCheckBox" label="AutoRefresh" right="204" top="10" selected="true" click="confAutoRefreshControl();"/>
	        <mx:HSlider id="confAutoRefreshTimeSlider" right="37" top="10" width="162" minimum="5" maximum="120" snapInterval="5" value="15"/>
	        <mx:Label id="confTimerLabel" text="STOPPED" right="339" top="12"/>
	        <mx:Label width="23" id="lblRefreshInterval" text="{confAutoRefreshTimeSlider.value.toString()}" right="10" top="12"/>
	        <mx:Label id="confTimerSecCount" text="Label" right="433" top="12"/>
	        <mx:TextInput bottom="55" width="406" horizontalCenter="126"/>
	        <mx:ComboBox id="comboConfPlayfile" width="324" horizontalCenter="167" bottom="85" labelField="label" dataProvider="{freeswitch.getConfPlayfiles.lastResult}" ></mx:ComboBox>
        </mx:Canvas>
    </mx:TabNavigator>
	
</mx:Application>