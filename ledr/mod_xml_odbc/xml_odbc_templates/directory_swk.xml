<include>
  <template name="directory_swk" description="based on swk's shipment sql">
    <document type="freeswitch/xml">
      <xml-odbc-do name="replace_header_value" when-name="key" when-value="id" value="username"/>
      <xml-odbc-do name="query" on-empty-result-break-to="not_found" value="
        SELECT
          domains.uid AS domains_uid,
          users.uid AS users_uid,
          users.cidr,
          users.mailbox
        FROM
          domains,
          users
        WHERE
          users.${key} = '${user}' AND
          domains.name = '${domain}' AND
          users.domains_uid = domains.uid AND
          domains.enabled = '1' AND
          users.enabled = '1';"/>
      <section name="directory">
        <domain name="${domain}">
          <params>
            <xml-odbc-do name="query" value="
              SELECT
                name, value
              FROM
                domain_params
              WHERE
                domains_uid = '${domains_uid}';">
              <param name="${name}" value="${value}"/>
            </xml-odbc-do>
          </params>
          <variables>
            <xml-odbc-do name="query" value="
              SELECT
                name, value
              FROM
                domain_variables
              WHERE
                domains_uid = '${domains_uid}';">
              <variable name="${name}" value="${value}"/>
            </xml-odbc-do>
          </variables>
          <groups>
            <group name="default">
              <users>
                <user id="${user}" mailbox="${mailbox}" cidr="${cidr}">
                  <params>
                    <xml-odbc-do name="query" on-empty-result-break-to="not_found" value="
                      SELECT
                        name, value
                      FROM
                        user_params
                      WHERE
                        users_uid = '${users_uid}';">
                      <param name="${name}" value="${value}"/>
                    </xml-odbc-do>
                  </params>
                  <variables>
                    <xml-odbc-do name="query" value="
                      SELECT
                        name, value
                      FROM
                        user_variables
                      WHERE
                        users_uid = '${users_uid}';">
                      <variable name="${name}" value="${value}"/>
                    </xml-odbc-do>
                  </variables>
                </user>
              </users>
            </group>
            <xml-odbc-do name="query" value="
              SELECT
                name AS group_name
              FROM
                groups,
                group_members
              WHERE
                group_members.groups_uid = groups.uid AND
                users_uid = '${users_uid}';">
              <group name="${group_name}">
                <users>
                  <user id="${user}" type="pointer"/>
                </users>
              </group>
            </xml-odbc-do>
          </groups>
        </domain>
      </section>
    </document>
  </template>
</include>
